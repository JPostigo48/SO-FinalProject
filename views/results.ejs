<% const entradas = data.procesos_entrada; %>

<div class="h-full grid grid-cols-[42vw_58vw] gap-4 overflow-hidden">
  <div class="bg-white p-4 shadow rounded h-full flex flex-col overflow-hidden">
    <h3 class="text-xl font-semibold mb-2">Procesos capturados (<%= entradas.length %>)</h3>
    <p class="text-sm text-gray-600 mb-2">
      Los procesos se muestran en el orden en que fueron detectados. La ráfaga observada corresponde al incremento de tiempo de CPU en el intervalo de muestreo.
    </p>

    <div class="flex-1 min-h-0 overflow-auto">
      <div class="min-w-max">
        <table class="text-sm text-left w-full">
          <thead class="bg-gray-100 sticky top-0">
            <tr>
              <th class="py-1 px-2">PID</th>
              <th class="py-1 px-2">Nombre</th>
              <th class="py-1 px-2">t_llegada</th>
              <th class="py-1 px-2">utime</th>
              <th class="py-1 px-2">stime</th>
              <th class="py-1 px-2">cpu_total</th>
              <th class="py-1 px-2">burst_obs</th>
              <!-- <th class="py-1 px-2">muestras</th> -->
              <th class="py-1 px-2">estado</th>
            </tr>
          </thead>
          <tbody>
            <% entradas.forEach(proc => { %>
            <tr class="border-b">
              <td class="py-1 px-2 whitespace-nowrap"><%= proc.pid %></td>
              <td class="py-1 px-2 whitespace-nowrap"><%= proc.nombre %></td>
              <td class="py-1 px-2"><%= proc.t_llegada %></td>
              <td class="py-1 px-2"><%= proc.utime %></td>
              <td class="py-1 px-2"><%= proc.stime %></td>
              <td class="py-1 px-2"><%= proc.cpu_total %></td>
              <td class="py-1 px-2"><%= proc.burst_obs %></td>
              <!-- <td class="py-1 px-2"><%= proc.muestras %></td> -->
              <td class="py-1 px-2"><%= proc.estado %></td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="h-full flex flex-col gap-4 overflow-hidden">
    <div class="h-[45%] grid grid-cols-[19vw_35vw] gap-4 min-h-0 overflow-hidden">
      <div class="bg-white p-4 shadow rounded h-full flex flex-col min-h-0 overflow-hidden">
        <div class="vista vistaRR flex-1 min-h-0 flex flex-col overflow-hidden  min-w-0">
          <h3 class="text-lg font-semibold mb-2">Métricas Round Robin (Q= <%= quantum %>)</h3>
          <% const m = data.rr.metricas; %>
          <div class="flex-1 min-h-0 overflow-auto">
            <ul class="list-disc list-inside text-sm space-y-1">
              <li>Tiempo de espera promedio: <%= m.espera_promedio.toFixed(2) %></li>
              <li>Tiempo de retorno (turnaround) promedio: <%= m.turnaround_promedio.toFixed(2) %></li>
              <li>Tiempo de finalización total: <%= m.finalizacion_total %></li>
              <li>Throughput: <%= m.throughput.toFixed(2) %> procesos/unidad</li>
              <li>Tiempo de respuesta promedio: <%= m.respuesta_promedio.toFixed(2) %></li>
              <li>Nº de cambios de contexto: <%= m.context_switches %></li>
              <li>CPU idle time: <%= m.cpu_idle_time %></li>
            </ul>
          </div>
        </div>

        <div class="vista vistaSRTF flex-1 min-h-0 flex flex-col overflow-hidden">
          <h3 class="text-lg font-semibold mb-2">Métricas SRTF</h3>
          <% const ms = data.srtf.metricas; %>
          <div class="flex-1 min-h-0 overflow-auto">
            <ul class="list-disc list-inside text-sm space-y-1">
              <li>Tiempo de espera promedio: <%= ms.espera_promedio.toFixed(2) %></li>
              <li>Tiempo de retorno (turnaround) promedio: <%= ms.turnaround_promedio.toFixed(2) %></li>
              <li>Tiempo de finalización total: <%= ms.finalizacion_total %></li>
              <li>Throughput: <%= ms.throughput.toFixed(2) %> procesos/unidad</li>
              <li>Tiempo de respuesta promedio: <%= ms.respuesta_promedio.toFixed(2) %></li>
              <li>Nº de cambios de contexto: <%= ms.context_switches %></li>
              <li>CPU idle time: <%= ms.cpu_idle_time %></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="bg-white p-4 shadow rounded h-full flex flex-col min-h-0 overflow-hidden">
        <div class="vista vistaRR flex-1 min-h-0 flex flex-col overflow-hidden">
          <h3 class="text-lg font-semibold mb-2">Procesos finales RR</h3>
          <div class="flex-1 min-h-0 overflow-auto">
            <div class="min-w-max">
              <table class="text-sm text-left w-full">
                <thead class="bg-gray-100 sticky top-0">
                  <tr>
                    <th class="py-1 px-2">PID</th>
                    <th class="py-1 px-2">Nombre</th>
                    <th class="py-1 px-2">t_inicio</th>
                    <th class="py-1 px-2">t_fin</th>
                    <th class="py-1 px-2">turnaround</th>
                    <th class="py-1 px-2">waiting</th>
                    <th class="py-1 px-2">response</th>
                    <th class="py-1 px-2">contextos</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.rr.procesos_salida.forEach(p => { %>
                  <tr class="border-b">
                    <td class="py-1 px-2 whitespace-nowrap"><%= p.pid %></td>
                    <td class="py-1 px-2 whitespace-nowrap"><%= p.nombre %></td>
                    <td class="py-1 px-2"><%= p.t_inicio %></td>
                    <td class="py-1 px-2"><%= p.t_fin %></td>
                    <td class="py-1 px-2"><%= p.turnaround %></td>
                    <td class="py-1 px-2"><%= p.waiting_time %></td>
                    <td class="py-1 px-2"><%= p.response_time %></td>
                    <td class="py-1 px-2"><%= p.n_contextos %></td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="vista vistaSRTF flex-1 min-h-0 flex flex-col overflow-hidden">
          <h3 class="text-lg font-semibold mb-2">Procesos finales SRTF</h3>
          <div class="flex-1 min-h-0 overflow-auto">
            <div class="min-w-max">
              <table class="text-sm text-left w-full">
                <thead class="bg-gray-100 sticky top-0">
                  <tr>
                    <th class="py-1 px-2">PID</th>
                    <th class="py-1 px-2">Nombre</th>
                    <th class="py-1 px-2">t_inicio</th>
                    <th class="py-1 px-2">t_fin</th>
                    <th class="py-1 px-2">turnaround</th>
                    <th class="py-1 px-2">waiting</th>
                    <th class="py-1 px-2">response</th>
                    <th class="py-1 px-2">contextos</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.srtf.procesos_salida.forEach(p => { %>
                  <tr class="border-b">
                    <td class="py-1 px-2 whitespace-nowrap"><%= p.pid %></td>
                    <td class="py-1 px-2 whitespace-nowrap"><%= p.nombre %></td>
                    <td class="py-1 px-2"><%= p.t_inicio %></td>
                    <td class="py-1 px-2"><%= p.t_fin %></td>
                    <td class="py-1 px-2"><%= p.turnaround %></td>
                    <td class="py-1 px-2"><%= p.waiting_time %></td>
                    <td class="py-1 px-2"><%= p.response_time %></td>
                    <td class="py-1 px-2"><%= p.n_contextos %></td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="h-[55%] bg-white p-4 shadow rounded overflow-hidden min-h-0 flex flex-col">
      <div class="vista vistaRR flex-1 min-h-0 flex flex-col overflow-hidden">
        <h3 class="text-lg font-semibold mb-2">Diagrama de Gantt Round Robin</h3>

        <% const tlRR = data.rr.timeline || []; %>
        <% const totalRR = tlRR.length ? tlRR[tlRR.length - 1].fin : 0; %>
        <% const escala = 15; %>
        <% const rowH = 28; %>
        <% const filasRR = Array.from(new Set(tlRR.map(s => s.pid))); %>

        <div class="flex-1 min-h-0 overflow-auto border rounded">
          <div style="min-width:<%= Math.max(600, totalRR * escala + 220) %>px;">
            <div class="grid" style="grid-template-columns: 140px 1fr;">
              <div class="bg-gray-50 border-r sticky left-0">
                <div class="h-10 flex items-center px-2 text-xs font-semibold text-gray-600 border-b sticky top-0 bg-gray-50">PID</div>
                <% filasRR.forEach(pid => { %>
                  <div class="px-2 text-sm flex items-center border-b" style="height:<%= rowH %>px;">
                    <span class="font-mono"><%= pid %></span>
                  </div>
                <% }) %>
              </div>

              <div>
                <div class="h-10 border-b relative bg-gray-50 sticky top-0">
                  <% for (let t = 0; t <= totalRR; t += 5) { %>
                    <div class="absolute top-0 h-10 border-l text-[10px] text-gray-500" style="left:<%= t * escala %>px;">
                      <span class="ml-1"><%= t %></span>
                    </div>
                  <% } %>
                </div>

                <% filasRR.forEach(pid => { %>
                  <div class="relative border-b" style="height:<%= rowH %>px;">
                    <% tlRR.filter(s => s.pid === pid).forEach(seg => { %>
                      <div class="absolute top-1 bottom-1 rounded text-[10px] text-white flex items-center justify-center overflow-hidden"
                        style="left:<%= seg.inicio * escala %>px; width:<%= (seg.fin - seg.inicio) * escala %>px;
                              background-color: rgb(<%= (pid * 47) % 200 + 40 %>, <%= (pid * 83) % 200 + 40 %>, <%= (pid * 23) % 200 + 40 %>);">
                        <%= (seg.fin - seg.inicio) %>
                      </div>
                    <% }) %>
                  </div>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="vista vistaSRTF flex-1 min-h-0 flex flex-col overflow-hidden">
        <h3 class="text-lg font-semibold mb-2">Diagrama de Gantt SRTF</h3>

        <% const tlS = data.srtf.timeline || []; %>
        <% const totalS = tlS.length ? tlS[tlS.length - 1].fin : 0; %>
        <% const escala2 = 15; %>
        <% const rowH2 = 28; %>
        <% const filasS = Array.from(new Set(tlS.map(s => s.pid))); %>

        <div class="flex-1 min-h-0 overflow-auto border rounded">
          <div style="min-width:<%= Math.max(600, totalS * escala2 + 220) %>px;">
            <div class="grid" style="grid-template-columns: 140px 1fr;">
              <div class="bg-gray-50 border-r sticky left-0">
                <div class="h-10 flex items-center px-2 text-xs font-semibold text-gray-600 border-b sticky top-0 bg-gray-50">PID</div>
                <% filasS.forEach(pid => { %>
                  <div class="px-2 text-sm flex items-center border-b" style="height:<%= rowH2 %>px;">
                    <span class="font-mono"><%= pid %></span>
                  </div>
                <% }) %>
              </div>

              <div>
                <div class="h-10 border-b relative bg-gray-50 sticky top-0">
                  <% for (let t = 0; t <= totalS; t += 5) { %>
                    <div class="absolute top-0 h-10 border-l text-[10px] text-gray-500" style="left:<%= t * escala2 %>px;">
                      <span class="ml-1"><%= t %></span>
                    </div>
                  <% } %>
                </div>

                <% filasS.forEach(pid => { %>
                  <div class="relative border-b" style="height:<%= rowH2 %>px;">
                    <% tlS.filter(s => s.pid === pid).forEach(seg => { %>
                      <div class="absolute top-1 bottom-1 rounded text-[10px] text-white flex items-center justify-center overflow-hidden"
                        style="left:<%= seg.inicio * escala2 %>px; width:<%= (seg.fin - seg.inicio) * escala2 %>px;
                              background-color: rgb(<%= (pid * 47) % 200 + 40 %>, <%= (pid * 83) % 200 + 40 %>, <%= (pid * 23) % 200 + 40 %>);">
                        <%= (seg.fin - seg.inicio) %>
                      </div>
                    <% }) %>
                  </div>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .vista { display: none; }
</style>
